define(["jquery","core/ajax","core/notification","core/modal_factory","core/pending","core/str"],function(e,b,f,a,d,c){return{queue:[],queueActiveItem:false,competencyAddSingle:function(g){var j=this;console.log("Add single",g);var i=e(g).closest("table").attr("data-courseid");var l=e(g).closest("tr").attr("data-id");var k="core_competency_add_competency_to_course";var h={courseid:i,competencyid:l};j.queue.push({methodname:k,args:h,tr:e(g).closest("tr")});e(g).closest("tr").addClass("queue-pending");j.competencyQueue()},competencyAddMultiple:function(g){var l=this;var j=e(g).closest("tr");var m=j.attr("data-id");var i=j.closest("table").find("tr.childof-"+m);if(i.length>0){console.log("children",i);var k=i.first().hasClass("used");if(!k){i.each(function(){if(!e(this).hasClass("used")){l.competencyAddSingle(e(this).find(".addsingle"))}})}else{var h=e(g).closest("tr").find(".shortname").html();c.get_strings([{key:"competency:remove:title",component:"local_displace"},{key:"competency:remove:multiple",component:"local_displace",param:{shortname:h}},{key:"yes"},{key:"no"}]).done(function(n){f.confirm(n[0],n[1],n[2],n[3],function(){i.each(function(){if(e(this).hasClass("used")){l.competencyRemoveSingle(e(this).find(".removesingle"),true)}})})}).fail(f.exception)}}},competencyRemoveSingle:function(g,n){var k=this;if(typeof n==="undefined"){var h=e(g).closest("tr").find(".shortname").html();c.get_strings([{key:"competency:remove:title",component:"local_displace"},{key:"competency:remove:single",component:"local_displace",param:{shortname:h}},{key:"yes"},{key:"no"}]).done(function(o){f.confirm(o[0],o[1],o[2],o[3],function(){k.competencyRemoveSingle(g,true)})}).fail(f.exception)}else{console.log("Remove single",g);var j=e(g).closest("table").attr("data-courseid");var m=e(g).closest("tr").attr("data-id");var l="core_competency_remove_competency_from_course";var i={courseid:j,competencyid:m};k.queue.push({methodname:l,args:i,tr:e(g).closest("tr")});e(g).closest("tr").addClass("queue-pending");k.competencyQueue()}},competencyQueue:function(){var h=this;if(h.queueActiveItem){return}if(h.queue.length==0){return}var g=h.queue.shift();console.log("Queue Item",g);h.queueActiveItem=true;b.call([{methodname:g.methodname,args:g.args,done:function(i){e(g.tr).removeClass("queue-pending");console.log("Results of "+g.methodname,i);if(i){if(g.methodname=="core_competency_add_competency_to_course"){e(g.tr).addClass("used")}else{e(g.tr).removeClass("used")}e(g.tr).addClass("displace-alert success");setTimeout(function(){e(g.tr).removeClass("displace-alert success")},1000)}else{e(g.tr).addClass("displace-alert danger")}h.queueActiveItem=false;h.competencyQueue()},fail:function(i){e(g.tr).addClass("displace-alert danger");h.queueActiveItem=false;f.exception(i)}}])},modalDescription:function(g){var i=e(g).find(".description").html();var h=e(g).find(".shortname").html();a.create({title:h,body:i,},trigger).done(function(j){j.show()})},setRuleOutcomeOption:function(h){var i=new d();var k=[];var g=e(h).closest("tr").attr("data-id");var j=e(h).val();k=b.call([{methodname:"core_competency_set_course_competency_ruleoutcome",args:{coursecompetencyid:g,ruleoutcome:j}},{methodname:"tool_lp_data_for_course_competencies_page",args:{courseid:e(h).closest("table").attr("data-courseid"),moduleid:0}}]);k[1].then(function(l){e(h).addClass("displace-alert success");setTimeout(function(){e(h).removeClass("displace-alert success")},1000)}).then(i.resolve)},toggleInit:function(h){console.log(h);var i=this;var g=e("#coursecompetenciesadd-"+h);g.find('tr[data-path="/0/"]>td>a').each(function(){i.toggleNode(this)});g.find("tr.used").each(function(){i.toggleInitRecursive(this)})},toggleInitRecursive:function(i){var k=this;e(i).removeClass("hidden");e(i).addClass("children-visible");var h=parseInt(e(i).attr("data-childof"));if(h>0){var g=e(i).closest("table").find("tr[data-id="+h+"]");if(g.length>0){var j=e(g).attr("data-path");e("tr.childof-"+h).removeClass("hidden");k.toggleInitRecursive(g)}}},toggleNode:function(h){var i=e(h).closest("tr");var k=i.attr("data-id");var j=i.attr("data-path");var g=i.hasClass("children-visible");if(g){e("tr.childof-"+k).each(function(){var l=e(this).attr("data-path");e('tr[data-path^="'+l+'"]').addClass("hidden")});e(i).removeClass("children-visible")}else{e("tr.childof-"+k).removeClass("hidden");e(i).addClass("children-visible")}},}});